# WattBuddy System Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WATTBUDDY SMART ENERGY SYSTEM               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      SMARTPHONE/TABLET  â”‚
                    â”‚    (Flutter App)        â”‚
                    â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚   Dashboard     â”‚   â”‚
                    â”‚  â”‚                 â”‚   â”‚
                    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
                    â”‚  â”‚ â”‚Live Chart   â”‚ â”‚   â”‚
                    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
                    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
                    â”‚  â”‚ â”‚Sensor Data  â”‚ â”‚   â”‚
                    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
                    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
                    â”‚  â”‚ â”‚Relay Controlâ”‚ â”‚   â”‚
                    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP
                              â”‚ WiFi
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ESP32 Microcontroller  â”‚
                    â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ Web Server      â”‚   â”‚
                    â”‚  â”‚ (Port 80)       â”‚   â”‚
                    â”‚  â”‚                 â”‚   â”‚
                    â”‚  â”‚ /api/latest     â”‚   â”‚
                    â”‚  â”‚ /api/relay1/on  â”‚   â”‚
                    â”‚  â”‚ /api/relay1/off â”‚   â”‚
                    â”‚  â”‚ /api/relay2/on  â”‚   â”‚
                    â”‚  â”‚ /api/relay2/off â”‚   â”‚
                    â”‚  â”‚ /api/relay/stat â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ Calculations    â”‚   â”‚
                    â”‚  â”‚ - RMS calc      â”‚   â”‚
                    â”‚  â”‚ - Power calc    â”‚   â”‚
                    â”‚  â”‚ - Energy total  â”‚   â”‚
                    â”‚  â”‚ - Cost calc     â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ GPIO Control    â”‚   â”‚
                    â”‚  â”‚ - Relay 1: 23   â”‚   â”‚
                    â”‚  â”‚ - Relay 2: 19   â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â–¼       â–¼       â–¼          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ACS712  â”‚â”‚ZMPT101Bâ”‚â”‚Relay 1 â”‚â”‚ Relay 2  â”‚
              â”‚Current â”‚â”‚Voltage â”‚â”‚Module  â”‚â”‚ Module   â”‚
              â”‚Sensor  â”‚â”‚Sensor  â”‚â”‚        â”‚â”‚          â”‚
              â”‚        â”‚â”‚        â”‚â”‚ Device â”‚â”‚ Device   â”‚
              â”‚GPIO 34 â”‚â”‚GPIO 35 â”‚â”‚  1     â”‚â”‚   2      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                         â”‚ AC Power Input
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚AC Supply     â”‚
                    â”‚230V 50Hz     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
SENSOR â†’ ADC CONVERSION â†’ CALCULATION â†’ STORAGE â†’ API â†’ FLUTTER APP
  â”‚           â”‚              â”‚            â”‚        â”‚         â”‚
  â”‚           â”‚              â”‚            â”‚        â”‚         â”‚
  â”œâ”€ AC 230V  â”œâ”€ 0-3.3V      â”œâ”€ RMS Vrms â””â”€ File â”œâ”€ JSON   â”œâ”€ Chart
  â”‚           â”‚              â”‚            â”‚       â”‚         â”‚
  â””â”€ I/V      â””â”€ 12-bit      â””â”€ RMS Irms  â”‚       â””â”€ /api/  â””â”€ Readings
                                          â”‚           latest â”‚
                                    â”‚     â”‚                  â”‚
                                    â–¼     â–¼                  â–¼
                                  Power = Vrms Ã— Irms
                                  Energy += Power Ã— Time
                                  Cost = Energy Ã— Rate
```

---

## API Endpoint Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ESP32 REST API Endpoints                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  GET /api/latest                                     â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€â–º Returns: {                                      â”‚
â”‚       "voltage": 230.5,    â† Current RMS voltage    â”‚
â”‚       "current": 2.35,     â† Current RMS current    â”‚
â”‚       "power": 542.1,      â† Power = V Ã— I          â”‚
â”‚       "energy_kwh": 45.23, â† Total energy consumed  â”‚
â”‚       "cost": 316.61,      â† Cost = Energy Ã— Rate   â”‚
â”‚       "relay1": false,     â† Relay 1 state          â”‚
â”‚       "relay2": true,      â† Relay 2 state          â”‚
â”‚       "timestamp": 65432100 â† Millis since boot    â”‚
â”‚      }                                               â”‚
â”‚                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  GET /api/relay1/on                                 â”‚
â”‚  â”‚                                                   â”‚
â”‚  â”œâ”€â–º Sets GPIO 23 = LOW                             â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€â–º Returns: {"success":true,"relay":1,"state":true}â”‚
â”‚                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  GET /api/relay1/off                                â”‚
â”‚  â”‚                                                   â”‚
â”‚  â”œâ”€â–º Sets GPIO 23 = HIGH                            â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€â–º Returns: {"success":true,"relay":1,"state":false}â”‚
â”‚                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  GET /api/relay2/on / /api/relay2/off               â”‚
â”‚  GET /api/relay/status                              â”‚
â”‚  â”‚                                                   â”‚
â”‚  â””â”€â–º Similar responses for Relay 2 and status       â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Widget Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DashboardScreen (Stateful)             â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UserDetailsCard                      â”‚  â”‚
â”‚  â”‚ (Static)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MetricCards                          â”‚  â”‚
â”‚  â”‚ - Current Power (W)                  â”‚  â”‚
â”‚  â”‚ - Voltage (V)                        â”‚  â”‚
â”‚  â”‚ - Current (A)                        â”‚  â”‚
â”‚  â”‚ - Energy (kWh)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                        â”‚
â”‚                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RealtimePowerChart (NEW)             â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚  Line Chart (60 points)          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚  â”€â”€â”€ Live Power Data             â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚ Stats: Peak | Avg | Min             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                        â”‚
â”‚                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SensorDataWidget (NEW)               â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ âš¡ Voltage: 230.5 V              â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ğŸ”Œ Current: 2.35 A               â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ âš™ï¸  Power: 542.1 W                â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ğŸ’¡ Energy: 45.23 kWh             â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ğŸ’° Bill: â‚¹316.61                 â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                        â”‚
â”‚                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RelayControlWidget (NEW)             â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚ â”‚ Relay 1     â”‚ â”‚ Relay 2     â”‚     â”‚  â”‚
â”‚  â”‚ â”‚ [âœ“ ON]      â”‚ â”‚ [âŠ— OFF]     â”‚     â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚ Status: ON â•â•â•â•â•â•â• OFF              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                        â”‚
â”‚                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Chart + Bills (Static)               â”‚  â”‚
â”‚  â”‚ Monthly usage graph                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Update Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Update Intervals (Seconds)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ 0s â”Œâ”€ Fetch Data                                   â”‚
â”‚    â”œâ”€ Chart Updates                                â”‚
â”‚    â”œâ”€ Sensor Updates                               â”‚
â”‚    â”‚                                               â”‚
â”‚ 2s â”œâ”€ Fetch Data (REPEAT)                          â”‚
â”‚    â”œâ”€ Chart Updates                                â”‚
â”‚    â”œâ”€ Sensor Updates                               â”‚
â”‚    â”‚                                               â”‚
â”‚ 4s â”œâ”€ Fetch Data (REPEAT)                          â”‚
â”‚    â”œâ”€ Chart Updates                                â”‚
â”‚    â”œâ”€ Sensor Updates                               â”‚
â”‚    â”‚                                               â”‚
â”‚ 5s â””â”€ Relay Status Update                          â”‚
â”‚                                                     â”‚
â”‚ 10s â”œâ”€ Fetch Data (REPEAT)                         â”‚
â”‚     â”œâ”€ Chart Updates                               â”‚
â”‚     â””â”€ Sensor Updates                              â”‚
â”‚                                                     â”‚
â”‚ 15s â””â”€ Relay Status Update                         â”‚
â”‚                                                     â”‚
â”‚ ... (Pattern repeats)                              â”‚
â”‚                                                     â”‚
â”‚ Every 5 minutes (300s):                            â”‚
â”‚ â””â”€ Energy data saved to LittleFS (ESP32)           â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Signal Flow: Relay Control

```
User Taps Button
       â”‚
       â–¼
RelayControlWidget._toggleRelay1()
       â”‚
       â”œâ”€â–º Set isLoading = true
       â”‚
       â–¼
Esp32Service.controlRelay1On()
       â”‚
       â”œâ”€â–º HTTP GET to /api/relay1/on
       â”‚
       â–¼
ESP32 Web Server
       â”‚
       â”œâ”€â–º handleRelay1On()
       â”‚
       â”œâ”€â–º digitalWrite(GPIO 23, LOW)  â† Relay activation
       â”‚
       â”œâ”€â–º relay1_state = true
       â”‚
       â””â”€â–º Return JSON response
              â”‚
              â–¼
         Flutter receives response
              â”‚
              â”œâ”€â–º setState(relay1_on = true)
              â”‚
              â”œâ”€â–º Show success message
              â”‚
              â”œâ”€â–º Set isLoading = false
              â”‚
              â””â”€â–º Button updates with new state
```

---

## Error Handling Flow

```
API Call Attempt
       â”‚
       â”œâ”€â–º Timeout? (5 seconds)
       â”‚   â””â”€â–º Show "ESP32 Unreachable"
       â”‚
       â”œâ”€â–º No WiFi?
       â”‚   â””â”€â–º Show "Connecting to ESP32..."
       â”‚
       â”œâ”€â–º HTTP Error?
       â”‚   â””â”€â–º Show error code + message
       â”‚
       â”œâ”€â–º JSON Parse Error?
       â”‚   â””â”€â–º Log error, use default values
       â”‚
       â””â”€â–º Success âœ“
           â””â”€â–º Update UI with new data
```

---

## Hardware Pin Mapping

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ESP32 DevKit            â”‚
â”‚                                â”‚
â”‚   GPIO 23 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   (Relay 1)                â”‚   â”‚
â”‚                            â”‚   â”‚
â”‚   GPIO 19 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   (Relay 2)                â”‚   â”‚
â”‚                            â”‚   â”‚
â”‚   GPIO 34 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â” â”‚
â”‚   (ADC - Current)          â”‚ â”‚ â”‚
â”‚                            â”‚ â”‚ â”‚
â”‚   GPIO 35 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”¤
â”‚   (ADC - Voltage)          â”‚ â”‚ â”‚
â”‚                            â”‚ â”‚ â”‚
â”‚   GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚                            â”‚ â”‚ â”‚
â”‚   5V â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚   3.3V â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                â”‚
â”‚   WiFi Antenna                â”‚
â”‚   (Internal)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚      â”‚
        â”‚          â”‚      â””â”€â†’ ACS712 (5V)
        â”‚          â””â”€â”€â”€â”€â”€â”€â†’ ZMPT101B (3.3V)
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ 2-Channel Relay (5V)
                    - Device 1
                    - Device 2
```

---

## WiFi Network Diagram

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Router/WiFi AP     â”‚
     â”‚   gecIi (2.4GHz)     â”‚
     â”‚   Password: 66666666 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚          â”‚          â”‚
     â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phone  â”‚ â”‚ Tablet â”‚ â”‚   ESP32  â”‚
â”‚(App)   â”‚ â”‚(App)   â”‚ â”‚(192.168. â”‚
â”‚        â”‚ â”‚        â”‚ â”‚  1.100)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       HTTP (Port 80)
       Updates every 2s
```

---

## Memory & Performance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ESP32 Memory Usage                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚ Program Space: ~400KB                â”‚
â”‚ â”œâ”€ Main code                         â”‚
â”‚ â”œâ”€ WiFi stack                        â”‚
â”‚ â”œâ”€ ArduinoJSON library               â”‚
â”‚ â””â”€ WebServer                         â”‚
â”‚                                      â”‚
â”‚ SPIFFS/LittleFS: 64KB                â”‚
â”‚ â””â”€ energy.txt (4 bytes per update)   â”‚
â”‚                                      â”‚
â”‚ RAM: ~200KB available (out of 520KB) â”‚
â”‚ â”œâ”€ WiFi buffers                      â”‚
â”‚ â”œâ”€ JSON response buffer              â”‚
â”‚ â””â”€ Calculation variables             â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CPU Load:
- At rest: <1%
- Processing samples: ~5%
- Serving API request: ~10%
- Reading sensors: ~2%
```

---

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Security Layers                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ Layer 1: Network Isolation              â”‚
â”‚ â””â”€ Local WiFi only (no internet)       â”‚
â”‚    â””â”€ Accessible only on home WiFi     â”‚
â”‚                                         â”‚
â”‚ Layer 2: Physical Location              â”‚
â”‚ â””â”€ Must be within WiFi range           â”‚
â”‚    â””â”€ ~50m typical range               â”‚
â”‚                                         â”‚
â”‚ Layer 3: No Authentication              â”‚
â”‚ â””â”€ For local use only                  â”‚
â”‚ â””â”€ Requires HTTPS for public network   â”‚
â”‚                                         â”‚
â”‚ Layer 4: Rate Limiting (Future)         â”‚
â”‚ â””â”€ Limit API calls per IP              â”‚
â”‚                                         â”‚
â”‚ Layer 5: Encryption (Future)            â”‚
â”‚ â””â”€ HTTPS/TLS support                   â”‚
â”‚                                         â”‚
â”‚ Layer 6: Authentication (Future)        â”‚
â”‚ â””â”€ Token-based or API key              â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scalability Path

```
Phase 1: âœ… CURRENT (Single ESP32 + Local)
â””â”€ One ESP32
   One home WiFi
   Local mobile access

Phase 2: (Future) Multiple Devices
â””â”€ Multiple ESP32s
   Cloud backend
   Cloud database

Phase 3: (Future) Enterprise
â””â”€ Fleet management
   Advanced analytics
   Machine learning
   Historical reports
```

---

**Architecture Created**: January 22, 2026
**System Status**: âœ… Fully Implemented & Documented
